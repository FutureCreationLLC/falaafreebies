<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Falaa Freebies</title>
<style>
  :root{
    --bg1:#f7f7f8;
    --bg2:#ffffff;
    --card:#ffffff;
    --muted:#6b7280;
    --blue:#1967ff;
    --dark:#0f1720;
    --shadow: 0 8px 24px rgba(15,23,32,0.08);
    --radius:14px;
    --maxwidth:1100px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;}
  body{
    background: linear-gradient(180deg,var(--bg1),var(--bg2));
    color:var(--dark);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    display:flex;flex-direction:column;min-height:100vh;
  }

  /* Header */
  header{
    padding:20px 16px;
    text-align:center;
    position:relative;
    background:transparent;
  }
  h1{margin:0;font-size:28px;font-weight:800;letter-spacing:-0.02em;}
  .top-controls{position:absolute;right:12px;top:12px;}
  .icon-btn{background:transparent;border:0;padding:8px;border-radius:999px;cursor:pointer;position:relative;}
  .notif{position:absolute;right:2px;top:2px;min-width:18px;height:18px;border-radius:999px;background:#ef4444;color:white;font-size:12px;display:inline-flex;align-items:center;justify-content:center;padding:0 5px;font-weight:700;}

  /* Main area */
  main{flex:1;max-width:var(--maxwidth);margin:0 auto;width:100%;padding:12px 16px 120px;box-sizing:border-box;}
  .grid{display:grid;gap:16px;grid-template-columns:1fr;}
  @media(min-width:640px){ .grid{ grid-template-columns: repeat(2,1fr);} }
  @media(min-width:1100px){ .grid{ grid-template-columns: repeat(3,1fr);} }

  .card{
    background:var(--card);
    border-radius:var(--radius);
    border:1px solid rgba(15,23,32,0.04);
    box-shadow:var(--shadow);
    padding:12px;
    display:flex;flex-direction:column;min-height:220px;
  }
  .img-placeholder{
    background:linear-gradient(180deg,#efefef,#f3f3f3);
    border-radius:10px;
    height:160px;
    display:flex;align-items:center;justify-content:center;color:var(--muted);
    font-weight:600;
    overflow:hidden;
    flex-shrink:0;
  }
  .card h3{margin:12px 0 6px;font-size:18px;}
  .card p{margin:0;color:var(--muted);font-size:14px;line-height:1.35;flex:0 0 auto;}
  .card .meta{margin-top:auto;font-size:12px;color:#9aa4aa;margin-top:12px;display:flex;justify-content:space-between;align-items:center;}

  /* Floating post button */
  .post-wrap{position:fixed;left:50%;transform:translateX(-50%);bottom:78px;z-index:60;display:flex;align-items:center;flex-direction:column;gap:8px;}
  .post-btn{width:72px;height:72px;border-radius:999px;background:var(--blue);border:0;color:white;display:flex;align-items:center;justify-content:center;font-size:30px;box-shadow:0 12px 30px rgba(25,103,255,0.18);cursor:pointer;}
  .post-label{font-weight:700;color:var(--dark);font-size:13px;}

  /* Footer nav */
  footer{position:fixed;left:0;right:0;bottom:0;background:#0b1220;color:white;padding:10px 12px;box-shadow:0 -6px 20px rgba(2,6,23,0.18);z-index:50;}
  .nav{max-width:var(--maxwidth);margin:0 auto;display:flex;justify-content:space-between;align-items:center;padding:6px 6px;}
  .nav-btn{flex:1;text-align:center;padding:6px 8px;border-radius:12px;background:transparent;color:rgba(255,255,255,0.92);border:0;font-size:13px;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:6px;}
  .nav-btn svg{width:20px;height:20px;display:block;}
  .nav-btn.active{background:rgba(255,255,255,0.03);} 

  /* modal */
  .modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.36);display:flex;align-items:center;justify-content:center;z-index:80;}
  .modal{background:white;border-radius:12px;padding:18px;max-width:420px;width:92%;box-shadow:0 12px 40px rgba(2,6,23,0.18);}
  .form-row{display:flex;flex-direction:column;gap:8px;margin-bottom:10px;}
  input[type="text"],input[type="email"],input[type="tel"],textarea,input[type="file"]{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e6e9;font-size:14px;}
  .btn{padding:9px 12px;border-radius:10px;border:0;cursor:pointer;}
  .btn.primary{background:var(--blue);color:white;}
  .btn.ghost{background:transparent;border:1px solid rgba(10,10,10,0.06);}

  /* helpers */
  .row{display:flex;gap:8px}
  .muted{color:var(--muted);font-size:13px}
  @media(max-width:420px){ .post-btn{width:60px;height:60px;} h1{font-size:24px;} }
</style>
</head>
<body>

<header>
  <h1>Falaa Freebies</h1>
  <div class="top-controls">
    <button class="icon-btn" id="settingsBtn" title="Settings" aria-label="Settings">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden>
        <path d="M12 15a3 3 0 100-6 3 3 0 000 6z" stroke="#0f1720" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M19.4 15a1.6 1.6 0 00.3 1.8l.06.06a2 2 0 01-2.83 2.8l-.06-.06a1.6 1.6 0 00-1.9-.3 1.6 1.6 0 00-1 .8V21a2 2 0 01-4 0v-.06a1.6 1.6 0 00-1-.8 1.6 1.6 0 00-1.9.3l-.06.06A2 2 0 012.3 17.86l.06-.06a1.6 1.6 0 00.3-1.8 1.6 1.6 0 00-.9-1H3a2 2 0 010-4h.06a1.6 1.6 0 00.9-1 1.6 1.6 0 00-.3-1.8L2.3 6.14A2 2 0 015.1 3.36l.06.06a1.6 1.6 0 001.9.3H7a1.6 1.6 0 001-.8V3a2 2 0 014 0v.06c.12.6.6 1.1 1.2 1.3h.01c.7.25 1.4.06 1.9-.3l.06-.06A2 2 0 0119.7 4.3l-.06.06a1.6 1.6 0 00-.3 1.8V8c0 .5.4 1 1 1h.06a2 2 0 010 4h-.06c-.6 0-1.1.4-1.2 1z" stroke="#0f1720" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span id="notifBubble" class="notif" style="display:none">0</span>
    </button>
  </div>
</header>

<main>
  <p id="signupHint" class="muted" style="text-align:center;margin:0 0 12px;"></p>

  <section id="mainSection" class="grid">
    <!-- Items injected here -->
  </section>
</main>

<!-- Floating Post -->
<div class="post-wrap">
  <button class="post-btn" id="postBtn" title="Post an Item" aria-label="Post an Item">＋</button>
  <div class="post-label">Post an Item</div>
</div>

<!-- Footer nav -->
<footer>
  <div class="nav">
    <button class="nav-btn active" data-tab="home"><svg viewBox="0 0 24 24" fill="none"><path d="M3 10.5L12 4l9 6.5" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg><div>Home</div></button>
    <button class="nav-btn" data-tab="my"><svg viewBox="0 0 24 24" fill="none"><path d="M3 7h18" stroke="currentColor" stroke-width="1.4"/><path d="M7 11h10v10H7z" stroke="currentColor" stroke-width="1.4"/></svg><div>My Items</div></button>
    <button class="nav-btn" data-tab="profile"><svg viewBox="0 0 24 24" fill="none"><path d="M12 11a4 4 0 100-8 4 4 0 000 8z" stroke="currentColor" stroke-width="1.4"/></svg><div>Profile</div></button>
    <button class="nav-btn" data-tab="upload"><svg viewBox="0 0 24 24" fill="none"><path d="M12 5v14" stroke="currentColor" stroke-width="1.4"/><path d="M5 12h14" stroke="currentColor" stroke-width="1.4"/></svg><div>Upload</div></button>
    <button class="nav-btn" data-tab="settings"><svg viewBox="0 0 24 24" fill="none"><path d="M12 15a3 3 0 100-6 3 3 0 000 6z" stroke="currentColor" stroke-width="1.2"/></svg><div>Settings</div></button>
  </div>
</footer>

<!-- Signup modal -->
<div id="signupModal" style="display:none">
  <div class="modal-back" id="signupBack">
    <div class="modal" role="dialog" aria-modal="true">
      <h2 style="margin:0 0 10px;font-size:18px;">Create an account</h2>
      <div style="font-size:13px;color:#6b7280;margin-bottom:12px;">Sign up with phone or email. Uploads are free.</div>
      <form id="signupForm">
        <div class="form-row">
          <input id="nameIn" type="text" placeholder="Name (optional)" />
          <input id="emailIn" type="email" placeholder="Email" />
          <input id="phoneIn" type="tel" placeholder="Phone number" />
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;">
          <button type="button" class="btn ghost" id="closeSignup">Close</button>
          <button type="submit" class="btn primary">Create account</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Upload modal -->
<div id="uploadModal" style="display:none">
  <div class="modal-back" id="uploadBack">
    <div class="modal" role="dialog" aria-modal="true">
      <h2 style="margin:0 0 10px;font-size:18px;">Post a free item</h2>
      <div style="font-size:13px;color:#6b7280;margin-bottom:12px;">Items posted here are free to the community.</div>
      <form id="uploadForm">
        <div class="form-row">
          <input id="titleIn" type="text" placeholder="Item title (e.g., Couch)" required />
          <textarea id="descIn" rows="3" placeholder="Short description (e.g., Gently used couch in great condition)"></textarea>
          <input id="imgIn" type="file" accept="image/*" />
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;">
          <button type="button" class="btn ghost" id="cancelUpload">Cancel</button>
          <button type="submit" class="btn primary">Post item</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
/* Drop-in frontend connecting to your backend.
   1) Set BACKEND to your backend URL (no trailing slash)
   2) Backend must have:
      - POST /users/register  (returns { user, token })
      - POST /users/login     (returns { user, token })
      - POST /items           (multipart; auth header Bearer)
      - GET  /items/country/:country
*/

const BACKEND = "http://localhost:5000"; // <<< change to your backend URL

const $ = (s, root=document) => root.querySelector(s);
const $$ = (s, root=document) => Array.from(root.querySelectorAll(s));

const STORAGE_USER = 'falaa_user_v1';
const STORAGE_TOKEN = 'falaa_token_v1';

let user = JSON.parse(localStorage.getItem(STORAGE_USER) || 'null');
let token = localStorage.getItem(STORAGE_TOKEN) || null;
let items = [];
let notif = 0;

function setUserAndToken(u, t){
  user = u;
  token = t;
  if(u) localStorage.setItem(STORAGE_USER, JSON.stringify(u)); else localStorage.removeItem(STORAGE_USER);
  if(t) localStorage.setItem(STORAGE_TOKEN, t); else localStorage.removeItem(STORAGE_TOKEN);
  updateHeaderHint();
}

function updateHeaderHint(){
  const hint = $('#signupHint');
  if(!hint) return;
  if(!user) hint.textContent = 'Sign up to post items and see who posted items near you.';
  else hint.textContent = `Signed in as ${user.name || user.email || user.phone}`;
  updateNotifUI();
}

function updateNotifUI(){
  const nb = $('#notifBubble');
  if(!nb) return;
  if(notif>0){ nb.style.display='inline-flex'; nb.textContent = notif>99? '99+': String(notif); } else nb.style.display='none';
}

async function fetchItemsByCountry(country){
  try{
    const url = `${BACKEND}/items/country/${encodeURIComponent(country || '')}`;
    const res = await fetch(url);
    if(!res.ok) throw new Error('Failed to fetch items');
    const data = await res.json();
    items = data;
    renderGrid();
  }catch(err){
    console.warn('Fetch items failed:', err);
    items = [];
    renderGrid();
  }
}

function renderGrid(){
  const grid = $('#mainSection');
  grid.innerHTML='';
  if(!items || items.length===0){
    const s = document.createElement('div');
    s.style.gridColumn='1/-1'; s.style.textAlign='center'; s.style.color='#94a3b8'; s.style.padding='28px 10px';
    s.textContent='No freebies yet — be the first to post!';
    grid.appendChild(s);
    return;
  }
  items.forEach(it=>{
    const card = document.createElement('article'); card.className='card';
    const imgWrap = document.createElement('div'); imgWrap.className='img-placeholder';
    if(it.image){
      const im = document.createElement('img');
      im.src = it.image.indexOf('http') === 0 ? it.image : (BACKEND + it.image);
      im.alt = it.title;
      im.style.width='100%'; im.style.height='100%'; im.style.objectFit='cover'; im.style.borderRadius='10px';
      imgWrap.textContent=''; imgWrap.appendChild(im);
    } else {
      imgWrap.textContent='Image';
    }
    const h = document.createElement('h3'); h.textContent=it.title;
    const p = document.createElement('p'); p.textContent=it.description || '';
    const meta = document.createElement('div'); meta.className='meta';
    const left = document.createElement('div'); left.textContent = it.postedBy && it.postedBy.name ? it.postedBy.name : '';
    const right = document.createElement('div'); right.textContent = new Date(it.postedAt || it.createdAt).toLocaleString();
    meta.appendChild(left); meta.appendChild(right);
    card.appendChild(imgWrap); card.appendChild(h); card.appendChild(p); card.appendChild(meta);
    grid.appendChild(card);
  });
}

/* modal controls */
function showSignup(show=true){ $('#signupModal').style.display = show ? 'block' : 'none'; if(show) $('#nameIn').focus(); }
function showUpload(show=true){ $('#uploadModal').style.display = show ? 'block' : 'none'; if(show) $('#titleIn').focus(); }
function resetUploadForm(){ $('#titleIn').value=''; $('#descIn').value=''; if($('#imgIn')) $('#imgIn').value=''; }

/* init */
(async function init(){
  updateHeaderHint();
  renderGrid();

  // try to load items for user country if present, else load all (empty string)
  if(user && user.country) await fetchItemsByCountry(user.country);
  else await fetchItemsByCountry('');

  // Post button
  $('#postBtn').addEventListener('click', ()=>{
    if(!user){ showSignup(true); return; }
    showUpload(true);
  });

  // settings: simple sign out if signed
  $('#settingsBtn').addEventListener('click', ()=>{
    const ans = confirm(user ? `Sign out ${user.name || user.email || user.phone}?` : 'You are not signed in. Sign up now?');
    if(ans){
      if(user){ setUserAndToken(null, null); showSignup(true); }
      else showSignup(true);
    }
  });

  // nav
  $$('.nav-btn').forEach(b=>{
    b.addEventListener('click', async ()=> {
      $$('.nav-btn').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      const tab = b.dataset.tab;
      if(tab==='upload'){ if(!user) showSignup(true); else showUpload(true); }
      else if(tab==='my'){ if(!user){ alert('Sign in to view your items.'); return; } await fetchMyItems(); }
      else { if(user && user.country) fetchItemsByCountry(user.country); else fetchItemsByCountry(''); }
    });
  });

  // SIGNUP -> POST /users/register
  $('#signupForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const name = $('#nameIn').value.trim() || 'Anonymous';
    const email = $('#emailIn').value.trim();
    const phone = $('#phoneIn').value.trim();
    if(!email && !phone){ alert('Please provide an email or phone number.'); return; }
    const password = prompt('Choose a password for your account:');
    if(!password){ alert('Password required'); return; }
    const country = prompt('Country (optional):') || '';

    try {
      const res = await fetch(`${BACKEND}/users/register`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ name, email, phone, password, country })
      });
      const data = await res.json();
      if(!res.ok){ alert('Sign up failed: ' + (data.error || data.message || res.status)); return; }
      setUserAndToken(data.user, data.token);
      alert('Account created and logged in.');
      showSignup(false);
      if(data.user && data.user.country) fetchItemsByCountry(data.user.country);
      else fetchItemsByCountry(country || '');
    } catch(err){
      console.error(err); alert('Sign up error');
    }
  });
  $('#closeSignup').addEventListener('click', ()=> showSignup(false));
  $('#signupBack').addEventListener('click', (e)=> { if(e.target===$('#signupBack')) showSignup(false); });

  // UPLOAD -> image from phone -> POST /items (multipart/form-data)
  $('#uploadForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    if(!user){ alert('Please sign in before posting.'); showSignup(true); return; }
    const title = $('#titleIn').value.trim();
    const description = $('#descIn').value.trim();
    const imageInput = $('#imgIn');
    const country = (user && user.country) ? user.country : (prompt('Enter country for this item (optional):') || '');
    if(!title){ alert('Please provide an item title.'); return; }
    if(!imageInput){ alert('Image input not found.'); return; }
    const file = imageInput.files && imageInput.files[0];

    const formData = new FormData();
    formData.append('title', title);
    formData.append('description', description);
    formData.append('country', country);
    if(file) formData.append('image', file);

    try {
      const res = await fetch(`${BACKEND}/items`, {
        method: 'POST',
        headers: token ? { 'Authorization': 'Bearer ' + token } : {},
        body: formData
      });
      const data = await res.json();
      if(!res.ok){ alert('Upload failed: ' + (data.error || res.status)); return; }

      items.unshift(data);
      renderGrid();
      notif = (notif || 0) + 1;
      updateNotifUI();
      resetUploadForm();
      showUpload(false);
      alert('Item posted successfully.');
    } catch(err){
      console.error('Upload error:', err);
      alert('Upload error: ' + err.message);
    }
  });

  $('#cancelUpload').addEventListener('click', ()=> showUpload(false));
  $('#uploadBack').addEventListener('click', (e)=> { if(e.target===$('#uploadBack')) showUpload(false); });

  // helper: fetch my items (by filtering server response)
  async function fetchMyItems(){
    if(!user){ alert('Sign in first'); return; }
    try {
      const country = user.country || '';
      const res = await fetch(`${BACKEND}/items/country/${encodeURIComponent(country)}`);
      if(!res.ok) throw new Error('Failed to fetch items');
      const data = await res.json();
      const uid = user._id || user.id;
      const mine = data.filter(it => (it.postedBy && (it.postedBy._id === uid || it.postedBy === uid)) || (!it.postedBy && it.postedBy === uid));
      if(mine.length===0){ alert('You have not posted any items yet.'); return; }
      items = mine;
      renderGrid();
    } catch(err){
      console.error(err); alert('Failed to fetch your items');
    }
  }

  // signIn helper (use from console or wire to an actual login form)
  window.signIn = async function(email, password){
    try {
      const res = await fetch(`${BACKEND}/users/login`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ email, password })
      });
      const data = await res.json();
      if(res.ok && data.token){ setUserAndToken(data.user, data.token); alert('Signed in'); if(data.user && data.user.country) fetchItemsByCountry(data.user.country); }
      else alert('Sign in failed: ' + (data.error||data.message));
    } catch(e){
      console.error(e); alert('Sign in error');
    }
  };

})(); // init end
</script>
</body>
</html>
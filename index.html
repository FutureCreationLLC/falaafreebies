<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Falaa Freebies</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif;}
body{background:#121212;color:#fff;overflow-x:hidden;}
.top-bar{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#1f1f1f;position:sticky;top:0;z-index:100;border-bottom:1px solid #333;}
.top-bar h1{font-size:1.5rem;}
.top-bar button{background:#2979ff;border:none;padding:8px 12px;color:#fff;border-radius:6px;cursor:pointer;font-size:1rem;}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px;padding:12px;}
.grid-item{background:#1f1f1f;border-radius:8px;overflow:hidden;cursor:pointer;display:flex;flex-direction:column;}
.grid-item img{width:100%;height:120px;object-fit:cover;}
.grid-item h3{padding:8px;font-size:.9rem;text-align:center;}
.upload-btn{position:fixed;bottom:24px;right:24px;background:#2979ff;color:#fff;border:none;padding:16px;border-radius:50%;font-size:1.5rem;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.4);z-index:100;}
.modal{display:none;position:fixed;z-index:200;left:0;top:0;width:100%;height:100%;overflow:auto;background:rgba(0,0,0,0.7);justify-content:center;align-items:center;}
.modal-content{background:#1f1f1f;padding:20px;border-radius:10px;width:90%;max-width:400px;text-align:center;}
.modal-content h2{margin-bottom:16px;}
.modal-content input,.modal-content select{width:100%;padding:10px;margin-bottom:12px;border-radius:6px;border:none;outline:none;}
.modal-content button{width:100%;padding:10px;border-radius:6px;border:none;background:#2979ff;color:#fff;cursor:pointer;font-size:1rem;}
body::-webkit-scrollbar{width:8px;}
body::-webkit-scrollbar-thumb{background:#555;border-radius:4px;}
body::-webkit-scrollbar-track{background:#1f1f1f;}
</style>
</head>
<body>

<header class="top-bar">
  <h1>Falaa Freebies</h1>
  <button id="settingsBtn">⚙️</button>
</header>

<section id="featuredGrid" class="grid featured-grid"></section>
<section id="feed" class="grid feed-grid"></section>

<button id="uploadBtn" class="upload-btn">⬆️</button>

<div id="loginModal" class="modal">
  <div class="modal-content">
    <h2>Login with Phone</h2>
    <input type="text" id="phoneNumber" placeholder="+233XXXXXXXXX">
    <button id="sendCodeBtn">Send Code</button>
    <input type="text" id="verificationCode" placeholder="Enter code" style="display:none;">
    <button id="verifyCodeBtn" style="display:none;">Verify Code</button>
  </div>
</div>

<div id="uploadModal" class="modal">
  <div class="modal-content">
    <h2>Upload Item</h2>
    <input type="file" id="imageFile" accept="image/*">
    <input type="text" id="itemTitle" placeholder="Item title">
    <select id="itemCategory">
      <option value="Household">Household items</option>
      <option value="BabyToys">Baby toys</option>
      <option value="Bikes">Bikes</option>
      <option value="CarParts">Car parts</option>
      <option value="ChristmasGifts">Christmas gifts</option>
      <option value="Other">Other</option>
    </select>
    <button id="uploadItemBtn">Upload</button>
  </div>
</div>

<script type="module">
document.addEventListener('DOMContentLoaded', async()=>{

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getAuth, RecaptchaVerifier, signInWithPhoneNumber, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, startAfter, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";
import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-storage.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCB3TOwlnDAdh_x5NvLSCyORX_6oZbsZGc",
  authDomain: "falaa-freebies.firebaseapp.com",
  projectId: "falaa-freebies",
  storageBucket: "falaa-freebies.firebasestorage.app",
  messagingSenderId: "842425176920",
  appId: "1:842425176920:web:aa538c8212f12dd41fcb2d"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// DOM
const loginModal=document.getElementById('loginModal');
const uploadModal=document.getElementById('uploadModal');
const uploadBtn=document.getElementById('uploadBtn');
const settingsBtn=document.getElementById('settingsBtn');

const phoneInput=document.getElementById('phoneNumber');
const sendCodeBtn=document.getElementById('sendCodeBtn');
const codeInput=document.getElementById('verificationCode');
const verifyCodeBtn=document.getElementById('verifyCodeBtn');

const imageFile=document.getElementById('imageFile');
const itemTitle=document.getElementById('itemTitle');
const itemCategory=document.getElementById('itemCategory');

const featuredGrid=document.getElementById('featuredGrid');
const feedGrid=document.getElementById('feed');

let lastVisible=null;
let loading=false;
let confirmationResultGlobal;

// User Country
async function getUserCountry(){
try{const res=await fetch('https://ipapi.co/json/');const data=await res.json();return data.country_name||'Unknown';}
catch(e){return'Unknown';}
}
const userCountry=await getUserCountry();

// Settings Button
settingsBtn.addEventListener('click',()=>{alert('Settings tapped!');});

// Upload Button
uploadBtn.addEventListener('click',()=>{if(!auth.currentUser){loginModal.style.display='flex';}else{uploadModal.style.display='flex';}});

// Phone Login
window.recaptchaVerifier=new RecaptchaVerifier('sendCodeBtn',{'size':'invisible'},auth);
sendCodeBtn.addEventListener('click',()=>{
const phone=phoneInput.value.trim();if(!phone)return alert('Enter phone');
signInWithPhoneNumber(auth,phone,window.recaptchaVerifier)
.then(cr=>{confirmationResultGlobal=cr;codeInput.style.display='block';verifyCodeBtn.style.display='block';alert('Code sent');})
.catch(e=>alert(e.message));
});
verifyCodeBtn.addEventListener('click',()=>{
const code=codeInput.value.trim();if(!code)return alert('Enter code');
confirmationResultGlobal.confirm(code).then(res=>{alert('Login successful: '+res.user.phoneNumber);loginModal.style.display='none';codeInput.style.display='none';verifyCodeBtn.style.display='none';phoneInput.value='';})
.catch(e=>alert('Incorrect code'));
});

// Upload Item
uploadItemBtn.addEventListener('click',async()=>{
if(!auth.currentUser)return alert('Login first');
const file=imageFile.files[0];const title=itemTitle.value.trim();const cat=itemCategory.value;
if(!file||!title)return alert('Enter title and select image');
const country=await getUserCountry();
const sRef=ref(storage,`images/${Date.now()}_${file.name}`);
const uploadTask=uploadBytesResumable(sRef,file);
uploadTask.on('state_changed',null,e=>alert(e.message),async()=>{
const url=await getDownloadURL(uploadTask.snapshot.ref);
await addDoc(collection(db,'posts'),{title,category:cat,country,imageURL:url,userId:auth.currentUser.uid,timestamp:serverTimestamp()});
alert('Upload successful!');imageFile.value='';itemTitle.value='';itemCategory.value='Household';uploadModal.style.display='none';
});
});

// Feed
async function loadFeatured(){
const q=query(collection(db,'posts'),orderBy('timestamp','desc'),limit(6));
const snap=await getDocs(q);featuredGrid.innerHTML='';
snap.forEach(doc=>{const d=doc.data();if(d.country===userCountry)featuredGrid.appendChild(createItem(d));});
}
async function loadFeed(){
if(loading)return;loading=true;
let q;if(lastVisible)q=query(collection(db,'posts'),orderBy('timestamp','desc'),startAfter(lastVisible),limit(10));
else q=query(collection(db,'posts'),orderBy('timestamp','desc'),limit(10));
const snap=await getDocs(q);
if(!snap.empty)lastVisible=snap.docs[snap.docs.length-1];
snap.forEach(doc=>{const d=doc.data();if(d.country===userCountry)feedGrid.appendChild(createItem(d));});
loading=false;
}
function createItem(d){const div=document.createElement('div');div.className='grid-item';div.innerHTML=`<img src="${d.imageURL}" alt="${d.title}"><h3>${d.title}</h3>`;return div;}
window.addEventListener('scroll',()=>{if(window.innerHeight+window.scrollY>=document.body.offsetHeight-100)loadFeed();});

// Initial Load
loadFeatured();loadFeed();

// Close Modals
window.addEventListener('click',e=>{if(e.target===loginModal)loginModal.style.display='none';if(e.target===uploadModal)uploadModal.style.display='none';});

});
</script>

</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Falaa Freebies</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif;}
body{background:#121212;color:#fff;overflow-x:hidden;}
.top-bar{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#1f1f1f;position:sticky;top:0;z-index:100;border-bottom:1px solid #333;}
.top-bar h1{font-size:1.5rem;}
.top-bar button{background:#2979ff;border:none;padding:8px 12px;color:#fff;border-radius:6px;cursor:pointer;font-size:1rem;}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px;padding:12px;}
.grid-item{background:#1f1f1f;border-radius:8px;overflow:hidden;cursor:pointer;display:flex;flex-direction:column;}
.grid-item img{width:100%;height:120px;object-fit:cover;}
.grid-item h3{padding:8px;font-size:.9rem;text-align:center;}
.upload-btn{position:fixed;bottom:24px;right:24px;background:#2979ff;color:#fff;border:none;padding:16px;border-radius:50%;font-size:1.5rem;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.4);z-index:100;}
.modal{display:none;position:fixed;z-index:200;left:0;top:0;width:100%;height:100%;overflow:auto;background:rgba(0,0,0,0.7);justify-content:center;align-items:center;}
.modal-content{background:#1f1f1f;padding:20px;border-radius:10px;width:90%;max-width:400px;text-align:center;}
.modal-content h2{margin-bottom:16px;}
.modal-content input,.modal-content select{width:100%;padding:10px;margin-bottom:12px;border-radius:6px;border:none;outline:none;}
.modal-content button{width:100%;padding:10px;border-radius:6px;border:none;background:#2979ff;color:#fff;cursor:pointer;font-size:1rem;}
body::-webkit-scrollbar{width:8px;}
body::-webkit-scrollbar-thumb{background:#555;border-radius:4px;}
body::-webkit-scrollbar-track{background:#1f1f1f;}
</style>
</head>
<body>

<header class="top-bar">
  <h1>Falaa Freebies</h1>
  <button id="settingsBtn">⚙️</button>
</header>

<section id="featuredGrid" class="grid featured-grid"></section>
<section id="feed" class="grid feed-grid"></section>

<button id="uploadBtn" class="upload-btn">⬆️</button>

<div id="loginModal" class="modal">
  <div class="modal-content">
    <h2>Login with Phone</h2>
    <input type="text" id="phoneNumber" placeholder="+233XXXXXXXXX">
    <button id="sendCodeBtn">Send Code</button>
    <input type="text" id="verificationCode" placeholder="Enter code" style="display:none;">
    <button id="verifyCodeBtn" style="display:none;">Verify Code</button>
  </div>
</div>

<div id="uploadModal" class="modal">
  <div class="modal-content">
    <h2>Upload Item</h2>
    <input type="file" id="imageFile" accept="image/*">
    <input type="text" id="itemTitle" placeholder="Item title">
    <select id="itemCategory">
      <option value="Household">Household items</option>
      <option value="BabyToys">Baby toys</option>
      <option value="Bikes">Bikes</option>
      <option value="CarParts">Car parts</option>
      <option value="ChristmasGifts">Christmas gifts</option>
      <option value="Other">Other</option>
    </select>
    <button id="uploadItemBtn">Upload</button>
  </div>
</div>

<script type="module">
document.addEventListener('DOMContentLoaded', async()=>{

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getAuth, RecaptchaVerifier, signInWithPhoneNumber, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, startAfter, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";
import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-storage.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCB3TOwlnDAdh_x5NvLSCyORX_6oZbsZGc",
  authDomain: "falaa-freebies.firebaseapp.com",
  projectId: "falaa-freebies",
  storageBucket: "falaa-freebies.firebasestorage.app",
  messagingSenderId: "842425176920",
  appId: "1:842425176920:web:aa538c8212f12dd41fcb2d"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// DOM
const loginModal=document.getElementById('loginModal');
const uploadModal=document.getElementById('uploadModal');
const uploadBtn=document.getElementById('uploadBtn');
const settingsBtn=document.getElementById('settingsBtn');

const phoneInput=document.getElementById('phoneNumber');
const sendCodeBtn=document.getElementById('sendCodeBtn');
const codeInput=document.getElementById('verificationCode');
const verifyCodeBtn=document.getElementById('verifyCodeBtn');

const imageFile=document.getElementById('imageFile');
const itemTitle=document.getElementById('itemTitle');
const itemCategory=document.getElementById('itemCategory');

const featuredGrid=document.getElementById('featuredGrid');
const feedGrid=document.getElementById('feed');

let lastVisible=null;
let loading=false;
let confirmationResultGlobal;

// User Country
async function getUserCountry(){
try{const res=await fetch('https://ipapi.co/json/');const data=await res.json();return data.country_name||'Unknown';}
catch(e){return'Unknown';}
}
const userCountry=await getUserCountry();

// Settings Button
settingsBtn.addEventListener('click',()=>{alert('Settings tapped!');});

// Upload Button
uploadBtn.addEventListener('click',()=>{if(!auth.currentUser){loginModal.style.display='flex';}else{uploadModal.style.display='flex';}});

// Phone Login
window.recaptchaVerifier=new RecaptchaVerifier('sendCodeBtn',{'size':'invisible'},auth);
sendCodeBtn.addEventListener('click',()=>{
const phone=phoneInput.value.trim();if(!phone)return alert('Enter phone');
signInWithPhoneNumber(auth,phone,window.recaptchaVerifier)
.then(cr=>{confirmationResultGlobal=cr;codeInput.style.display='block';verifyCodeBtn.style.display='block';alert('Code sent');})
.catch(e=>alert(e.message));
});
verifyCodeBtn.addEventListener('click',()=>{
const code=codeInput.value.trim();if(!code)return alert('Enter code');
confirmationResultGlobal.confirm(code).then(res=>{alert('Login successful: '+res.user.phoneNumber);loginModal.style.display='none';codeInput.style.display='none';verifyCodeBtn.style.display='none';phoneInput.value='';})
.catch(e=>alert('Incorrect code'));
});

// Upload Item
uploadItemBtn.addEventListener('click',async()=>{
if(!auth.currentUser)return alert('Login first');
const file=imageFile.files[0];const title=itemTitle.value.trim();const cat=itemCategory.value;
if(!file||!title)return alert('Enter title and select image');
const country=await getUserCountry();
const sRef=ref(storage,`images/${Date.now()}_${file.name}`);
const uploadTask=uploadBytesResumable(sRef,file);
uploadTask.on('state_changed',null,e=>alert(e.message),async()=>{
const url=await getDownloadURL(uploadTask.snapshot.ref);
await addDoc(collection(db,'posts'),{title,category:cat,country,imageURL:url,userId:auth.currentUser.uid,timestamp:serverTimestamp()});
alert('Upload successful!');imageFile.value='';itemTitle.value='';itemCategory.value='Household';uploadModal.style.display='none';
});
});

// Feed
async function loadFeatured(){
const q=query(collection(db,'posts'),orderBy('timestamp','desc'),limit(6));
const snap=await getDocs(q);featuredGrid.innerHTML='';
snap.forEach(doc=>{const d=doc.data();if(d.country===userCountry)featuredGrid.appendChild(createItem(d));});
}
async function loadFeed(){
if(loading)return;loading=true;
let q;if(lastVisible)q=query(collection(db,'posts'),orderBy('timestamp','desc'),startAfter(lastVisible),limit(10));
else q=query(collection(db,'posts'),orderBy('timestamp','desc'),limit(10));
const snap=await getDocs(q);
if(!snap.empty)lastVisible=snap.docs[snap.docs.length-1];
snap.forEach(doc=>{const d=doc.data();if(d.country===userCountry)feedGrid.appendChild(createItem(d));});
loading=false;
}
function createItem(d){const div=document.createElement('div');div.className='grid-item';div.innerHTML=`<img src="${d.imageURL}" alt="${d.title}"><h3>${d.title}</h3>`;return div;}
window.addEventListener('scroll',()=>{if(window.innerHeight+window.scrollY>=document.body.offsetHeight-100)loadFeed();});

// Initial Load
loadFeatured();loadFeed();

// Close Modals
window.addEventListener('click',e=>{if(e.target===loginModal)loginModal.style.display='none';if(e.target===uploadModal)uploadModal.style.display='none';});

});
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Falaa Freebies</title>

<!-- React & ReactDOM -->
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

<!-- React Router DOM -->
<script src="https://unpkg.com/react-router-dom@6/umd/react-router-dom.development.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<!-- Babel -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- TailwindCSS -->
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.2/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">

<div id="root"></div>

<script type="text/babel">

const { BrowserRouter, Routes, Route, useNavigate, Navigate } = ReactRouterDOM;

const firebaseConfig = {
  apiKey: "AIzaSyCB3TOwlnDAdh_x5NvLSCyORX_6oZbsZGc",
  authDomain: "falaa-freebies.firebaseapp.com",
  projectId: "falaa-freebies",
  storageBucket: "falaa-freebies.firebasestorage.app",
  messagingSenderId: "842425176920",
  appId: "1:842425176920:web:aa538c8212f12dd41fcb2d",
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

const africaCountries = [
  "Algeria","Angola","Benin","Botswana","Burkina Faso","Burundi","Cabo Verde","Cameroon","Central African Republic","Chad","Comoros","Congo (Congo-Brazzaville)","Djibouti","Egypt","Equatorial Guinea","Eritrea","Eswatini","Ethiopia","Gabon","Gambia","Ghana","Guinea","Guinea-Bissau","Ivory Coast","Kenya","Lesotho","Liberia","Libya","Madagascar","Malawi","Mali","Mauritania","Mauritius","Morocco","Mozambique","Namibia","Niger","Nigeria","Rwanda","Sao Tome and Principe","Senegal","Seychelles","Sierra Leone","Somalia","South Africa","South Sudan","Sudan","Tanzania","Togo","Tunisia","Uganda","Zambia","Zimbabwe"
];

function App() {
  const [user,setUser] = React.useState(null);
  React.useEffect(()=> auth.onAuthStateChanged(u => setUser(u)), []);
  return (
    <BrowserRouter>
      <Routes>
        <Route path="/" element={user ? <Navigate to="/dashboard"/> : <SignUp />} />
        <Route path="/signin" element={user ? <Navigate to="/dashboard"/> : <SignIn />} />
        <Route path="/dashboard" element={user ? <Dashboard user={user}/> : <Navigate to="/" />} />
        <Route path="/upload" element={user ? <Upload user={user}/> : <Navigate to="/" />} />
        <Route path="/settings" element={user ? <Settings user={user}/> : <Navigate to="/" />} />
      </Routes>
    </BrowserRouter>
  );
}

function SignUp() {
  const [email,setEmail]=React.useState("");
  const [password,setPassword]=React.useState("");
  const [country,setCountry]=React.useState("");
  const navigate = useNavigate();

  const handleSignUp = async () => {
    if(!email || !password || !country) return alert("Fill all fields");
    const cred = await auth.createUserWithEmailAndPassword(email,password);
    await db.collection("users").doc(cred.user.uid).set({
      email,
      country,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    navigate("/dashboard");
  };

  return (
    <div className="min-h-screen flex flex-col items-center justify-center p-4">
      <h1 className="text-2xl font-bold mb-4">Sign Up</h1>
      <input type="email" placeholder="Email" className="mb-2 p-2 border rounded w-full" value={email} onChange={e=>setEmail(e.target.value)}/>
      <input type="password" placeholder="Password" className="mb-2 p-2 border rounded w-full" value={password} onChange={e=>setPassword(e.target.value)}/>
      <select className="mb-2 p-2 border rounded w-full" value={country} onChange={e=>setCountry(e.target.value)}>
        <option value="">Select Country</option>
        {africaCountries.map(c=><option key={c} value={c}>{c}</option>)}
      </select>
      <button onClick={handleSignUp} className="bg-blue-500 text-white px-4 py-2 rounded w-full">Sign Up</button>
      <p className="mt-2">Already have an account? <span className="text-blue-500 cursor-pointer" onClick={()=>navigate("/signin")}>Sign In</span></p>
    </div>
  );
}

function SignIn() {
  const [email,setEmail]=React.useState("");
  const [password,setPassword]=React.useState("");
  const navigate = useNavigate();

  const handleSignIn = async () => {
    if(!email || !password) return alert("Fill all fields");
    await auth.signInWithEmailAndPassword(email,password);
    navigate("/dashboard");
  };

  return (
    <div className="min-h-screen flex flex-col items-center justify-center p-4">
      <h1 className="text-2xl font-bold mb-4">Sign In</h1>
      <input type="email" placeholder="Email" className="mb-2 p-2 border rounded w-full" value={email} onChange={e=>setEmail(e.target.value)}/>
      <input type="password" placeholder="Password" className="mb-2 p-2 border rounded w-full" value={password} onChange={e=>setPassword(e.target.value)}/>
      <button onClick={handleSignIn} className="bg-green-500 text-white px-4 py-2 rounded w-full">Sign In</button>
      <p className="mt-2">Don't have an account? <span className="text-blue-500 cursor-pointer" onClick={()=>navigate("/")}>Sign Up</span></p>
    </div>
  );
}

function Dashboard({user}) {
  const [items,setItems]=React.useState([]);
  const [userData,setUserData]=React.useState(null);
  const navigate = useNavigate();

  React.useEffect(()=>{
    const userRef = db.collection("users").doc(user.uid);
    userRef.get().then(doc => setUserData(doc.data()));
  }, [user]);

  React.useEffect(()=>{
    if(!userData) return;
    const q = db.collection("items").where("country","==",userData.country).orderBy("createdAt","desc");
    const unsubscribe = q.onSnapshot(snapshot=>{
      setItems(snapshot.docs.map(doc=>({id:doc.id,...doc.data()})));
    });
    return ()=>unsubscribe();
  }, [userData]);

  return (
    <div className="min-h-screen p-4">
      <nav className="flex justify-between mb-4">
        <div className="flex gap-2">
          <button onClick={()=>navigate("/upload")} className="bg-blue-500 text-white px-3 py-1 rounded">+ Add Item</button>
          <button onClick={()=>navigate("/settings")} className="bg-gray-500 text-white px-3 py-1 rounded">Settings</button>
        </div>
        <button onClick={()=>auth.signOut()} className="bg-red-500 text-white px-3 py-1 rounded">Sign Out</button>
      </nav>
      <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
        {items.map(item=><ItemCard key={item.id} item={item}/>)}
      </div>
    </div>
  );
}

function ItemCard({item}) {
  return (
    <div className="border rounded p-2 shadow">
      {item.imageURL && <img src={item.imageURL} alt="" className="w-full h-40 object-cover rounded"/>}
      <p className="font-bold mt-2">{item.description}</p>
      <p className="text-sm text-gray-600">{item.location}</p>
    </div>
  );
}

function Upload({user}) {
  const [description,setDescription]=React.useState("");
  const [location,setLocation]=React.useState("");
  const [image,setImage]=React.useState(null);
  const [progress,setProgress]=React.useState(0);
  const [userData,setUserData]=React.useState(null);
  const navigate = useNavigate();

  React.useEffect(()=>{
    db.collection("users").doc(user.uid).get().then(doc => setUserData(doc.data()));
  }, [user]);

  const handleUpload=()=>{
    if(!description || !location || !image) return alert("Fill all fields");
    const imageRef = storage.ref(`itemImages/${Date.now()}_${image.name}`);
    const uploadTask = imageRef.put(image);
    uploadTask.on("state_changed", snapshot=>{
      setProgress(Math.floor(snapshot.bytesTransferred / snapshot.totalBytes * 100));
    }, err=>{console.error(err)}, async ()=>{
      const imageURL = await uploadTask.snapshot.ref.getDownloadURL();
      await db.collection("items").add({
        description,
        location,
        imageURL,
        country: userData.country,
        createdBy: user.uid,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      setDescription(""); setLocation(""); setImage(null); setProgress(0);
      navigate("/dashboard");
    });
  };

  return (
    <div className="min-h-screen p-4 flex flex-col gap-2">
      <input type="text" placeholder="Description" className="p-2 border rounded" value={description} onChange={e=>setDescription(e.target.value)}/>
      <input type="text" placeholder="Location" className="p-2 border rounded" value={location} onChange={e=>setLocation(e.target.value)}/>
      <input type="file" accept="image/*" onChange={e=>setImage(e.target.files[0])}/>
      {progress>0 && <p>Uploading: {progress}%</p>}
      <button onClick={handleUpload} className="bg-blue-500 text-white p-2 rounded">Upload</button>
    </div>
  );
}

function Settings({user}) {
  const [name,setName]=React.useState(""); 
  const [photo,setPhoto]=React.useState(null); 
  const [profileURL,setProfileURL]=React.useState("");

  React.useEffect(()=>{
    db.collection("users").doc(user.uid).get().then(docSnap=>{
      if(docSnap.exists) setProfileURL(docSnap.data().profilePictureURL||"");
    });
  },[user]);

  const handleSave=()=>{
    if(photo){
      const imageRef = storage.ref(`userProfilePictures/${user.uid}/${Date.now()}_${photo.name}`);
      imageRef.put(photo).then(async snap=>{
        const url = await snap.ref.getDownloadURL();
        db.collection("users").doc(user.uid).set({profilePictureURL:url},{merge:true});
        setProfileURL(url);
      });
    }
    if(name) auth.currentUser.updateProfile({displayName:name});
    alert("Profile updated");
  };

  return (
    <div className="min-h-screen p-4 flex flex-col gap-2">
      <input type="text" placeholder="Name" className="p-2 border rounded" value={name} onChange={e=>setName(e.target.value)}/>
      <input type="file" accept="image/*" onChange={e=>setPhoto(e.target.files[0])}/>
      {profileURL && <img src={profileURL} alt="" className="w-32 h-32 object-cover rounded-full"/>}
      <button onClick={handleSave} className="bg-green-500 text-white p-2 rounded">Save Profile</button>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);

</script>
</body>
</html>

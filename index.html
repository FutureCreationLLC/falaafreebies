<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Falaa Freebies</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.2/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
<div id="app" class="min-h-screen flex items-center justify-center p-4"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCB3TOwlnDAdh_x5NvLSCyORX_6oZbsZGc",
  authDomain: "falaa-freebies.firebaseapp.com",
  projectId: "falaa-freebies",
  storageBucket: "falaa-freebies.firebasestorage.app",
  messagingSenderId: "842425176920",
  appId: "1:842425176920:web:aa538c8212f12dd41fcb2d",
  measurementId: "G-YQFW6R14L6"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

const africaCountries = [
"Algeria","Angola","Benin","Botswana","Burkina Faso","Burundi","Cabo Verde","Cameroon","Central African Republic","Chad","Comoros","Congo (Congo-Brazzaville)","Djibouti","Egypt","Equatorial Guinea","Eritrea","Eswatini","Ethiopia","Gabon","Gambia","Ghana","Guinea","Guinea-Bissau","Ivory Coast","Kenya","Lesotho","Liberia","Libya","Madagascar","Malawi","Mali","Mauritania","Mauritius","Morocco","Mozambique","Namibia","Niger","Nigeria","Rwanda","Sao Tome and Principe","Senegal","Seychelles","Sierra Leone","Somalia","South Africa","South Sudan","Sudan","Tanzania","Togo","Tunisia","Uganda","Zambia","Zimbabwe"
];

let currentUser = null;
const app = document.getElementById('app');

function show(element){ app.innerHTML=''; app.appendChild(element); }

function createInput(placeholder,type='text'){
  const input=document.createElement('input');
  input.type=type;
  input.placeholder=placeholder;
  input.className="p-2 border rounded w-full mb-2";
  return input;
}

function createButton(text,onClick){
  const btn=document.createElement('button');
  btn.textContent=text;
  btn.className="bg-blue-500 text-white px-4 py-2 rounded w-full mb-2";
  btn.onclick=onClick;
  return btn;
}

function showPinLogin(){
  const container=document.createElement('div'); container.className="w-full max-w-sm";
  const title=document.createElement('h1'); title.className="text-2xl font-bold mb-4 text-center"; title.textContent="Enter PIN to Unlock";
  const pinInput=createInput("Enter your PIN","password");
  const nameInput=createInput("Your Name (first time only)");
  const countrySelect=document.createElement('select'); countrySelect.className="p-2 border rounded w-full mb-2";
  const defaultOpt=document.createElement('option'); defaultOpt.value=""; defaultOpt.textContent="Select Country (first time)"; countrySelect.appendChild(defaultOpt);
  africaCountries.forEach(c=>{ const opt=document.createElement('option'); opt.value=c; opt.textContent=c; countrySelect.appendChild(opt);});
  const submitBtn=createButton("Unlock",async ()=>{
    const pin=pinInput.value.trim(); if(!pin) return alert("Enter PIN");
    const userDoc=await db.collection("users").doc(pin).get();
    if(userDoc.exists){ currentUser={pin,...userDoc.data()}; showDashboard(); }
    else{
      const name=nameInput.value.trim(); const country=countrySelect.value;
      if(!name||!country) return alert("Enter name and country to create PIN");
      await db.collection("users").doc(pin).set({name,country});
      currentUser={pin,name,country};
      showDashboard();
    }
  });
  container.appendChild(title); container.appendChild(pinInput); container.appendChild(nameInput); container.appendChild(countrySelect); container.appendChild(submitBtn);
  show(container);
}

async function showDashboard(){
  const container=document.createElement('div'); container.className="w-full max-w-4xl";
  const header=document.createElement('div'); header.className="flex justify-between items-center mb-4";
  const title=document.createElement('h1'); title.className="text-xl font-bold"; title.textContent=`Falaa Freebies - ${currentUser.country}`;
  const logoutBtn=createButton("Logout",()=>{currentUser=null; showPinLogin();}); logoutBtn.className="bg-red-500 text-white px-3 py-1 rounded"; header.appendChild(title); header.appendChild(logoutBtn);

  const uploadSection=document.createElement('div'); uploadSection.className="mb-4 p-4 border rounded";
  const descInput=createInput("Item Description"); const locInput=createInput("Item Location"); const contactInput=createInput("Contact Number"); const fileInput=document.createElement('input'); fileInput.type="file"; fileInput.accept="image/*"; fileInput.className="mb-2";
  const uploadBtn=createButton("Upload Item",async ()=>{
    const description=descInput.value.trim(); const location=locInput.value.trim(); const contact=contactInput.value.trim(); const file=fileInput.files[0];
    if(!description||!location||!contact||!file) return alert("Fill all fields");
    const fileRef=storage.ref(`itemImages/${Date.now()}_${file.name}`); const uploadTask=fileRef.put(file);
    uploadTask.on("state_changed",null,console.error,async ()=>{
      const imageURL=await uploadTask.snapshot.ref.getDownloadURL();
      const docRef=await db.collection("items").add({description,location,contact,country:currentUser.country,imageURL,createdBy:currentUser.pin,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
      descInput.value=""; locInput.value=""; contactInput.value=""; fileInput.value="";
      loadItems(itemsContainer);
    });
  });
  uploadSection.appendChild(descInput); uploadSection.appendChild(locInput); uploadSection.appendChild(contactInput); uploadSection.appendChild(fileInput); uploadSection.appendChild(uploadBtn);

  const itemsContainer=document.createElement('div'); itemsContainer.className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4";
  container.appendChild(header); container.appendChild(uploadSection); container.appendChild(itemsContainer);
  show(container); loadItems(itemsContainer);
}

async function loadItems(container){
  container.innerHTML="";
  const snapshot=await db.collection("items").where("country","==",currentUser.country).orderBy("createdAt","desc").get();
  snapshot.docs.forEach(doc=>{
    const item=doc.data();
    const card=document.createElement('div'); card.className="border rounded p-2 shadow flex flex-col";
    if(item.imageURL){ const img=document.createElement('img'); img.src=item.imageURL; img.className="w-full h-40 object-cover rounded"; card.appendChild(img);}
    const desc=document.createElement('p'); desc.className="font-bold mt-2"; desc.textContent=item.description;
    const loc=document.createElement('p'); loc.className="text-sm text-gray-600"; loc.textContent=item.location;

    const btn=document.createElement('button'); btn.textContent="I'm Interested"; btn.className="bg-green-500 text-white p-1 rounded mt-2"; 
    btn.onclick=()=>{ showChat(item.createdBy,doc.id,item.description); };

    card.appendChild(desc); card.appendChild(loc); card.appendChild(btn);
    container.appendChild(card);
  });
}

async function showChat(otherPin,itemId,itemDesc){
  const container=document.createElement('div'); container.className="w-full max-w-md p-4";
  const backBtn=createButton("Back",()=>{showDashboard();}); backBtn.className="bg-gray-500 text-white px-2 py-1 rounded mb-2";
  const title=document.createElement('h2'); title.className="text-lg font-bold mb-2"; title.textContent=`Chat about "${itemDesc}"`;
  const messagesDiv=document.createElement('div'); messagesDiv.className="h-64 overflow-y-auto border p-2 mb-2";

  const input=createInput("Type message...");
  const sendBtn=createButton("Send",async ()=>{
    const text=input.value.trim(); if(!text) return;
    const chatId=[currentUser.pin,otherPin].sort().join("_");
    const chatRef=db.collection("chats").doc(chatId);
    const chatDoc=await chatRef.get();
    if(!chatDoc.exists) await chatRef.set({participants:[currentUser.pin,otherPin],lastUpdated:firebase.firestore.FieldValue.serverTimestamp()});
    await chatRef.collection("messages").add({senderPin:currentUser.pin,text,timestamp:firebase.firestore.FieldValue.serverTimestamp()});
    input.value="";
  });

  container.appendChild(backBtn); container.appendChild(title); container.appendChild(messagesDiv); container.appendChild(input); container.appendChild(sendBtn);
  show(container);

  const chatId=[currentUser.pin,otherPin].sort().join("_");
  db.collection("chats").doc(chatId).collection("messages").orderBy("timestamp").onSnapshot(snapshot=>{
    messagesDiv.innerHTML="";
    snapshot.docs.forEach(doc=>{
      const msg=doc.data();
      const msgDiv=document.createElement('div');
      msgDiv.textContent=`${msg.senderPin===currentUser.pin?"You":"Other"}: ${msg.text}`;
      msgDiv.className=msg.senderPin===currentUser.pin?"text-right text-blue-600":"text-left text-gray-800";
      messagesDiv.appendChild(msgDiv);
      messagesDiv.scrollTop=messagesDiv.scrollHeight;
    });
  });
}

showPinLogin();
</script>
</body>
</html>

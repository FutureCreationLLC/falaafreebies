<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Role-Based Item App</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<style>
body{font-family:sans-serif;margin:0;padding:0;background:#f0f2f5;}
header{background:#4a90e2;color:white;padding:1rem;text-align:center;}
.container{padding:1rem;}
.hidden{display:none;}
button{margin:0.2rem;padding:0.5rem 1rem;background:#4a90e2;color:white;border:none;border-radius:5px;cursor:pointer;}
button:hover{background:#357ab8;}
input, textarea{width:100%;margin:0.3rem 0;padding:0.5rem;border-radius:5px;border:1px solid #ccc;}
.item-card{border:1px solid #ccc;border-radius:5px;padding:0.5rem;margin:0.5rem 0;background:white;}
.item-card img{max-width:100%;border-radius:5px;}
.chat-box{border:1px solid #ccc;border-radius:5px;padding:0.5rem;height:200px;overflow-y:scroll;background:white;}
.chat-input{display:flex;}
.chat-input input{flex:1;margin-right:0.5rem;}
.color-giver{background:#ffe0e0;}
.color-taker{background:#e0ffe0;}
.color-both{background:#e0e0ff;}
</style>
</head>
<body>
<header>Role-Based Item App</header>
<div class="container" id="auth-container">
<h2>Register / Login</h2>
<input type="email" id="email" placeholder="Email">
<input type="password" id="password" placeholder="Password">
<select id="role">
<option value="giver">Giver</option>
<option value="taker">Taker</option>
<option value="both">Both</option>
</select>
<button id="registerBtn">Register</button>
<button id="loginBtn">Login</button>
</div>

<div class="container hidden" id="giver-page">
<h2 class="color-giver">Giver Page</h2>
<h3>Your Items</h3>
<div id="giver-items"></div>
<h3>Upload Item</h3>
<input type="text" id="giver-item-name" placeholder="Item Name">
<input type="text" id="giver-item-desc" placeholder="Description">
<input type="text" id="giver-item-location" placeholder="Location">
<input type="file" id="giver-item-image">
<button id="giver-upload">Upload</button>
<button id="giver-logout">Logout</button>
</div>

<div class="container hidden" id="taker-page">
<h2 class="color-taker">Taker Page</h2>
<h3>Browse Items</h3>
<div id="browse-items"></div>
<button id="taker-logout">Logout</button>
</div>

<div class="container hidden" id="both-page">
<h2 class="color-both">Both Page</h2>
<h3>Your Items</h3>
<div id="both-items"></div>
<h3>Upload Item</h3>
<input type="text" id="both-item-name" placeholder="Item Name">
<input type="text" id="both-item-desc" placeholder="Description">
<input type="text" id="both-item-location" placeholder="Location">
<input type="file" id="both-item-image">
<button id="both-upload">Upload</button>
<h3>Browse Items</h3>
<div id="both-browse-items"></div>
<button id="both-logout">Logout</button>
</div>

<div class="container hidden" id="item-detail-page">
<h2>Item Detail</h2>
<div id="item-detail"></div>
<button id="item-back">Back</button>
<div class="chat-box" id="chat-box"></div>
<div class="chat-input">
<input type="text" id="chat-message" placeholder="Type message">
<button id="send-chat">Send</button>
</div>
</div>

<script>
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
  appId: "YOUR_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

let currentUser = null;
let currentRole = null;
let currentItemId = null;

// Auth
document.getElementById('registerBtn').onclick = async ()=>{
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  const role = document.getElementById('role').value;
  const user = await auth.createUserWithEmailAndPassword(email,password);
  await db.collection('users').doc(user.user.uid).set({role:role});
};

document.getElementById('loginBtn').onclick = async ()=>{
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  const user = await auth.signInWithEmailAndPassword(email,password);
};

auth.onAuthStateChanged(async user=>{
  if(user){
    currentUser = user;
    const doc = await db.collection('users').doc(user.uid).get();
    currentRole = doc.data().role;
    document.getElementById('auth-container').classList.add('hidden');
    if(currentRole==='giver') document.getElementById('giver-page').classList.remove('hidden');
    if(currentRole==='taker') loadTakerPage();
    if(currentRole==='both') loadBothPage();
  }else{
    document.getElementById('auth-container').classList.remove('hidden');
    document.getElementById('giver-page').classList.add('hidden');
    document.getElementById('taker-page').classList.add('hidden');
    document.getElementById('both-page').classList.add('hidden');
  }
});

// Logout
document.getElementById('giver-logout').onclick = ()=>auth.signOut();
document.getElementById('taker-logout').onclick = ()=>auth.signOut();
document.getElementById('both-logout').onclick = ()=>auth.signOut();

// Upload Item
async function uploadItem(name,desc,location,file,collection){
  const ref = storage.ref().child(`items/${file.name}_${Date.now()}`);
  await ref.put(file);
  const url = await ref.getDownloadURL();
  await db.collection(collection).add({
    uid: currentUser.uid,
    name:name,
    desc:desc,
    location:location,
    image:url,
    timestamp:firebase.firestore.FieldValue.serverTimestamp()
  });
}

// Giver Upload
document.getElementById('giver-upload').onclick = ()=>{
  const name = document.getElementById('giver-item-name').value;
  const desc = document.getElementById('giver-item-desc').value;
  const location = document.getElementById('giver-item-location').value;
  const file = document.getElementById('giver-item-image').files[0];
  uploadItem(name,desc,location,file,'items');
};

// Both Upload
document.getElementById('both-upload').onclick = ()=>{
  const name = document.getElementById('both-item-name').value;
  const desc = document.getElementById('both-item-desc').value;
  const location = document.getElementById('both-item-location').value;
  const file = document.getElementById('both-item-image').files[0];
  uploadItem(name,desc,location,file,'items');
};

// Load Items
function loadTakerPage(){
  document.getElementById('taker-page').classList.remove('hidden');
  db.collection('items').orderBy('timestamp').onSnapshot(snap=>{
    const container = document.getElementById('browse-items');
    container.innerHTML='';
    snap.forEach(doc=>{
      const data = doc.data();
      const div = document.createElement('div');
      div.classList.add('item-card');
      div.innerHTML=`<h4>${data.name}</h4><img src='${data.image}'><p>${data.desc}</p><p>${data.location}</p><button onclick="openItemDetail('${doc.id}')">View & Interest</button>`;
      container.appendChild(div);
    });
  });
}

function loadBothPage(){
  document.getElementById('both-page').classList.remove('hidden');
  db.collection('items').orderBy('timestamp').onSnapshot(snap=>{
    const container = document.getElementById('both-browse-items');
    container.innerHTML='';
    snap.forEach(doc=>{
      const data = doc.data();
      const div = document.createElement('div');
      div.classList.add('item-card');
      div.innerHTML=`<h4>${data.name}</h4><img src='${data.image}'><p>${data.desc}</p><p>${data.location}</p><button onclick="openItemDetail('${doc.id}')">View & Interest</button>`;
      container.appendChild(div);
    });
  });
  // Load own items
  db.collection('items').where('uid','==',currentUser.uid).orderBy('timestamp').onSnapshot(snap=>{
    const container = document.getElementById('both-items');
    container.innerHTML='';
    snap.forEach(doc=>{
      const data = doc.data();
      const div = document.createElement('div');
      div.classList.add('item-card');
      div.innerHTML=`<h4>${data.name}</h4><img src='${data.image}'><p>${data.desc}</p><p>${data.location}</p>`;
      container.appendChild(div);
    });
  });
}

// Item Detail & Chat
async function openItemDetail(id){
  currentItemId=id;
  document.getElementById('giver-page').classList.add('hidden');
  document.getElementById('taker-page').classList.add('hidden');
  document.getElementById('both-page').classList.add('hidden');
  document.getElementById('item-detail-page').classList.remove('hidden');
  const doc = await db.collection('items').doc(id).get();
  const data = doc.data();
  document.getElementById('item-detail').innerHTML=`<h3>${data.name}</h3><img src='${data.image}'><p>${data.desc}</p><p>${data.location}</p>`;
  loadChat();
}

document.getElementById('item-back').onclick=()=>{
  document.getElementById('item-detail-page').classList.add('hidden');
  if(currentRole==='giver') document.getElementById('giver-page').classList.remove('hidden');
  if(currentRole==='taker') document.getElementById('taker-page').classList.remove('hidden');
  if(currentRole==='both') document.getElementById('both-page').classList.remove('hidden');
}

// Chat
function loadChat(){
  const chatBox = document.getElementById('chat-box');
  db.collection('items').doc(currentItemId).collection('chat').orderBy('timestamp')
  .onSnapshot(snap=>{
    chatBox.innerHTML='';
    snap.forEach(doc=>{
      const m = doc.data();
      const p = document.createElement('p');
      p.textContent=`${m.sender}: ${m.message}`;
      chatBox.appendChild(p);
      chatBox.scrollTop=chatBox.scrollHeight;
    });
  });
}

document.getElementById('send-chat').onclick=()=>{
  const msg = document.getElementById('chat-message').value;
  db.collection('items').doc(currentItemId).collection('chat').add({
    sender:currentUser.email,
    message:msg,
    timestamp:firebase.firestore.FieldValue.serverTimestamp()
  });
  document.getElementById('chat-message').value='';
};
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Falaa Freebies â€¢ Free Stuff Near You</title>
<meta name="theme-color" content="#1967ff">
<link rel="manifest" href="data:application/manifest+json,{
  \"name\":\"Falaa Freebies\",
  \"short_name\":\"Falaa\",
  \"start_url\":\".\",
  \"display\":\"standalone\",
  \"background_color\":\"#f8f9fc\",
  \"theme_color\":\"#1967ff\",
  \"icons\":[{\"src\":\"https://falaa-freebies.web.app/icon.png\",\"sizes\":\"192x192\",\"type\":\"image/png\"}]
}">
<style>
:root{--bg:#f8f9fc;--card:#fff;--blue:#1967ff;--green:#10b981;--gray:#6b7280;--dark:#0f172a;--radius:16px;--shadow:0 8px 25px rgba(0,0,0,.08)}
*{margin:0;padding:0;box-sizing:border-box;font-family:system-ui,-apple-system,Arial,sans-serif}
body{background:var(--bg);color:var(--dark);min-height:100vh;display:flex;flex-direction:column}
header{padding:20px;text-align:center;background:var(--card);box-shadow:var(--shadow)}
h1{font-size:28px;font-weight:800;color:var(--blue)}
#status{font-size:14px;color:var(--gray);margin-top:8px}
main{flex:1;padding:16px 16px 100px;max-width:1200px;margin:0 auto;width:100%}
.grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fill,minmax(300px,1fr))}
.card{background:var(--card);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column}
.img{height:180px;background:#eee;overflow:hidden}
.img img{width:100%;height:100%;object-fit:cover}
.info{padding:16px;flex:1;display:flex;flex-direction:column}
.info h3{font-size:18px;margin-bottom:8px}
.info p{flex:1;color:#444;font-size:14.5px;margin:8px 0}
.meta{font-size:13px;color:var(--gray);display:flex;justify-content:space-between;align-items:center;margin-top:8px}
.dist{background:var(--green);color:white;padding:4px 10px;border-radius:20px;font-size:12px;font-weight:600}
.fab{position:fixed;bottom:90px;left:50%;transform:translateX(-50%);width:64px;height:64px;background:var(--blue);color:white;border:none;border-radius:50%;font-size:36px;box-shadow:0 8px 20px rgba(25,103,255,.4);cursor:pointer;z-index:10}
footer{position:fixed;bottom:0;left:0;right:0;background:#0b1220;color:white;padding:12px 0;box-shadow:0 -4px 20px rgba(0,0,0,.2)}
.nav{display:flex;max-width:1200px;margin:0 auto}
.nav button{flex:1;padding:12px;font-size:14px;background:none;border:none;color:rgba(255,255,255,.9);cursor:pointer}
.nav button.active{background:rgba(255,255,255,.1);border-radius:12px}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:100;opacity:0;pointer-events:none;transition:opacity .2s}
.modal.show{opacity:1;pointer-events:all}
.modal > div{background:var(--card);border-radius:var(--radius);width:90%;max-width:420px;padding:24px}
input,textarea{width:100%;padding:12px;border:1px solid #ddd;border-radius:12px;margin:10px 0;font-size:15px}
button.primary{background:var(--blue);color:white;padding:14px;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;width:100%;margin-top:10px}
#messages{max-height:60vh;overflow-y:auto;padding:10px;background:#f9f9f9;border-radius:12px;margin:10px 0;display:flex;flex-direction:column;gap:8px}
.msg{max-width:80%;padding:10px 14px;border-radius:18px;word-wrap:break-word;position:relative}
.msg.me{background:var(--blue);color:white;align-self:flex-end;border-bottom-right-radius:4px}
.msg.other{background:#eee;align-self:flex-start;border-bottom-left-radius:4px}
#chatInput{display:flex;gap:8px;margin-top:10px}
#chatInput input{flex:1}
#chatInput button{width:50px;height:50px;border-radius:50%;background:var(--blue);color:white;border:none;font-size:20px}
.loader{border:4px solid #f0f0f0;border-top:4px solid var(--blue);border-radius:50%;width:40px;height:40px;animation:s 1s linear infinite;margin:40px auto}
@keyframes s{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<header>
  <h1>Falaa Freebies</h1>
  <div id="status">Detecting location...</div>
</header>

<main>
  <section id="items" class="grid"></section>
</main>

<button class="fab" id="fab">+</button>

<footer>
  <div class="nav">
    <button class="active" data-tab="home">Home</button>
    <button data-tab="my">My Items</button>
    <button data-tab="profile">Profile</button>
  </div>
</footer>

<div class="modal" id="authModal">
  <div>
    <h2>Join Falaa Freebies</h2>
    <form id="authForm">
      <input id="name" type="text" placeholder="Your name (optional)">
      <input id="email" type="email" placeholder="Email" required>
      <input id="pass" type="password" placeholder="Password" required>
      <button type="submit" class="primary">Sign In / Create Account</button>
    </form>
  </div>
</div>

<div class="modal" id="postModal">
  <div>
    <h2>Post Free Item</h2>
    <form id="postForm">
      <input id="title" type="text" placeholder="Item title" required>
      <textarea id="desc" rows="3" placeholder="Description" required></textarea>
      <input id="photo" type="file" accept="image/*" required>
      <button type="submit" class="primary">Post Item</button>
    </form>
  </div>
</div>

<div class="modal" id="chatModal">
  <div>
    <h2 id="chatTitle">Chat</h2>
    <div id="messages"></div>
    <div id="chatInput">
      <input type="text" id="msgText" placeholder="Type a message..." autocomplete="off">
      <button id="sendMsg">Send</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, where, serverTimestamp, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js";
import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-messaging.js";

const app = initializeApp({
  apiKey: "AIzaSyCB3TOwlnDAdh_x5NvLSCyORX_6oZbsZGc",
  authDomain: "falaa-freebies.firebaseapp.com",
  projectId: "falaa-freebies",
  storageBucket: "falaa-freebies.firebasestorage.app",
  messagingSenderId: "842425176920",
  appId: "1:842425176920:web:aa538c8212f12dd41fcb2d"
});

const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);
const messaging = getMessaging(app);

let user = null, userLoc = null, currentChat = null;

const $ = s => document.querySelector(s);
const \[ = s => document.querySelectorAll(s);

function haversine(lat1, lon1, lat2, lon2) {
  const toRad = x => x * Math.PI / 180;
  const R = 6371;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
  return (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))).toFixed(1);
}

async function requestNotificationPermission() {
  if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission().then(perm => {
      if (perm === 'granted') subscribeToPush();
    });
  }
}

async function subscribeToPush() {
  try {
    const token = await getToken(messaging, { vapidKey: "BOFz7...YOUR_VAPID_KEY_HERE...REPLACE_THIS" }); // Generate at Firebase Console > Cloud Messaging > Web Push Certificates
    if (token && user) {
      await addDoc(collection(db, 'pushTokens'), {
        uid: user.uid,
        token,
        createdAt: serverTimestamp()
      });
    }
  } catch (err) { console.log("Push denied"); }
}

onMessage(messaging, (payload) => {
  new Notification(payload.notification.title, {
    body: payload.notification.body,
    icon: "/icon.png"
  });
});

async function getLocation() {
  if (!navigator.geolocation) return $('#status').textContent = "Location not supported";
  navigator.geolocation.getCurrentPosition(async pos => {
    const { latitude, longitude } = pos.coords;
    const res = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=\( {latitude}&longitude= \){longitude}&localityLanguage=en`);
    const data = await res.json();
    userLoc = { lat: latitude, lng: longitude, city: data.city || data.locality || "Nearby", country: data.countryName };
    \( ('#status').textContent = `Near \){userLoc.city}, ${userLoc.country}`;
    loadItems();
  }, () => {
    $('#status').textContent = "Showing all items";
    loadItems();
  });
}

function loadItems(filter = 'all') {
  const q = filter === 'my' && user
    ? query(collection(db, 'items'), where('userId', '==', user.uid), orderBy('createdAt', 'desc'))
    : query(collection(db, 'items'), orderBy('createdAt', 'desc'));

  onSnapshot(q, snap => {
    $('#items').innerHTML = snap.empty ? '<p style="text-align:center;color:var(--gray);padding:50px">No items yet</p>' : '';
    snap.forEach(d => {
      const item = d.data();
      const dist = userLoc && item.location ? haversine(userLoc.lat, userLoc.lng, item.location.lat, item.location.lng) : null;
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="img">\( {item.imageUrl ? `<img src=" \){item.imageUrl}" loading="lazy">` : ''}</div>
        <div class="info">
          <h3>${item.title}</h3>
          <p>${item.description}</p>
          <div class="meta">
            <span>${item.city || item.country}</span>
            \( {dist ? `<span class="dist"> \){dist} km away</span>` : ''}
          </div>
          \( {user && item.userId !== user.uid ? `<button onclick="openChat(' \){d.id}', '\( {item.title}', ' \){item.userId}')" style="margin-top:12px;padding:10px;background:var(--blue);color:white;border:none;border-radius:12px;cursor:pointer;width:100%">Message Giver</button>` : ''}
        </div>
      `;
      $('#items').appendChild(card);
    });
  });
}

window.openChat = async (itemId, title, giverId) => {
  currentChat = { itemId, title, giverId };
  $('#chatTitle').textContent = title;
  $('#messages').innerHTML = '';
  $('.modal').forEach(m => m.classList.remove('show'));
  $('#chatModal').classList.add('show');

  const chatId = [user.uid, giverId].sort().join('_') + '_' + itemId;
  const q = query(collection(db, 'chats', chatId, 'messages'), orderBy('sentAt'));

  onSnapshot(q, snap => {
    $('#messages').innerHTML = '';
    snap.forEach(doc => {
      const m = doc.data();
      const div = document.createElement('div');
      div.className = `msg ${m.senderId === user.uid ? 'me' : 'other'}`;
      div.textContent = m.text;
      $('#messages').appendChild(div);
    });
    \( ('#messages').scrollTop = \)('#messages').scrollHeight;
  });
};

$('#sendMsg').onclick = async () => {
  const text = $('#msgText').value.trim();
  if (!text || !currentChat) return;
  const chatId = [user.uid, currentChat.giverId].sort().join('_') + '_' + currentChat.itemId;
  await addDoc(collection(db, 'chats', chatId, 'messages'), {
    text,
    senderId: user.uid,
    senderName: user.displayName || user.email.split('@')[0],
    sentAt: serverTimestamp()
  });
  $('#msgText').value = '';

  // Send push notification to giver
  const giverDoc = await getDoc(doc(db, 'users', currentChat.giverId));
  if (giverDoc.exists()) {
    fetch('https://us-central1-falaa-freebies.cloudfunctions.net/sendChatNotification', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        toUid: currentChat.giverId,
        title: "New message on your item",
        body: `\( {user.displayName || 'Someone'} wrote: \){text.substring(0,50)}${text.length>50?'...':''}`,
        itemId: currentChat.itemId
      })
    });
  }
};

onAuthStateChanged(auth, async u => {
  user = u;
  if (user) {
    requestNotificationPermission();
    subscribeToPush();
  }
  loadItems();
  getLocation();
}); \]('.nav button').forEach(b => b.onclick = () => {
  $$('.nav button').forEach(x => x.classList.remove('active'));
  b.classList.add('active');
  loadItems(b.dataset.tab === 'my' ? 'my' : 'all');
});

\( ('#fab').onclick = () => user ? \)('#postModal').classList.add('show') : $('#authModal').classList.add('show');

$('#authForm').onsubmit = async e => {
  e.preventDefault();
  const email = \( ('#email').value, pass = \)('#pass').value, name = $('#name').value;
  try {
    await signInWithEmailAndPassword(auth, email, pass);
  } catch {
    const cred = await createUserWithEmailAndPassword(auth, email, pass);
    if (name) await updateProfile(cred.user, { displayName: name });
  }
  $('#authModal').classList.remove('show');
};

$('#postForm').onsubmit = async e => {
  e.preventDefault();
  const file = $('#photo').files[0];
  if (!file) return alert("Add photo");
  const btn = e.target.querySelector('button');
  btn.disabled = true; btn.textContent = "Posting...";

  const imgRef = ref(storage, 'items/' + Date.now() + '_' + file.name);
  await uploadBytes(imgRef, file);
  const imageUrl = await getDownloadURL(imgRef);

  await addDoc(collection(db, 'items'), {
    title: $('#title').value,
    description: $('#desc').value,
    imageUrl,
    userId: user.uid,
    userName: user.displayName || user.email.split('@')[0],
    city: userLoc?.city || "",
    country: userLoc?.country || "",
    location: userLoc ? { lat: userLoc.lat, lng: userLoc.lng } : null,
    createdAt: serverTimestamp()
  });

  $('#postModal').classList.remove('show');
  $('#postForm').reset();
  btn.disabled = false; btn.textContent = "Post Item";
};

document.addEventListener('click', e => {
  if (e.target.classList.contains('modal')) e.target.classList.remove('show');
});

loadItems();
</script>
</body>
</html>
